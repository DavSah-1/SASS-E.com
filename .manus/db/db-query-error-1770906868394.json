{
  "query": "-- Create cleanup type enum\nDO $$ BEGIN\n  CREATE TYPE cleanup_type AS ENUM ('age_based', 'storage_based', 'manual');\nEXCEPTION\n  WHEN duplicate_object THEN null;\nEND $$;\n\n-- Create cleanup status enum\nDO $$ BEGIN\n  CREATE TYPE cleanup_status AS ENUM ('success', 'partial', 'failed');\nEXCEPTION\n  WHEN duplicate_object THEN null;\nEND $$;\n\n-- Create cleanup_logs table\nCREATE TABLE IF NOT EXISTS cleanup_logs (\n  id SERIAL PRIMARY KEY,\n  cleanup_type cleanup_type NOT NULL,\n  files_deleted INTEGER DEFAULT 0 NOT NULL,\n  space_freed_mb TEXT DEFAULT '0.00' NOT NULL,\n  errors JSONB,\n  triggered_by TEXT,\n  status cleanup_status NOT NULL,\n  execution_time_ms INTEGER,\n  created_at TIMESTAMP DEFAULT NOW() NOT NULL\n);\n\n-- Create index on created_at for efficient querying\nCREATE INDEX IF NOT EXISTS idx_cleanup_logs_created_at ON cleanup_logs(created_at DESC);\n\n-- Create index on triggered_by for user-specific queries\nCREATE INDEX IF NOT EXISTS idx_cleanup_logs_triggered_by ON cleanup_logs(triggered_by);\n\n-- Enable RLS\nALTER TABLE cleanup_logs ENABLE ROW LEVEL SECURITY;\n\n-- RLS Policy: Only admins can read cleanup logs\nDROP POLICY IF EXISTS \"Admin users can read all cleanup logs\" ON cleanup_logs;\nCREATE POLICY \"Admin users can read all cleanup logs\"\n  ON cleanup_logs\n  FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM users\n      WHERE users.id = auth.uid()\n      AND users.role = 'admin'\n    )\n  );\n\n-- RLS Policy: Only admins can insert cleanup logs\nDROP POLICY IF EXISTS \"Admin users can insert cleanup logs\" ON cleanup_logs;\nCREATE POLICY \"Admin users can insert cleanup logs\"\n  ON cleanup_logs\n  FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM users\n      WHERE users.id = auth.uid()\n      AND users.role = 'admin'\n    )\n  );\n\n-- Grant permissions\nGRANT SELECT, INSERT ON cleanup_logs TO authenticated;\nGRANT USAGE, SELECT ON SEQUENCE cleanup_logs_id_seq TO authenticated;",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 3nggiiWQDu5Xrc9.root --database 8mC6ZNEwokHKmKSGT6E4hn --execute -- Create cleanup type enum\nDO $$ BEGIN\n  CREATE TYPE cleanup_type AS ENUM ('age_based', 'storage_based', 'manual');\nEXCEPTION\n  WHEN duplicate_object THEN null;\nEND $$;\n\n-- Create cleanup status enum\nDO $$ BEGIN\n  CREATE TYPE cleanup_status AS ENUM ('success', 'partial', 'failed');\nEXCEPTION\n  WHEN duplicate_object THEN null;\nEND $$;\n\n-- Create cleanup_logs table\nCREATE TABLE IF NOT EXISTS cleanup_logs (\n  id SERIAL PRIMARY KEY,\n  cleanup_type cleanup_type NOT NULL,\n  files_deleted INTEGER DEFAULT 0 NOT NULL,\n  space_freed_mb TEXT DEFAULT '0.00' NOT NULL,\n  errors JSONB,\n  triggered_by TEXT,\n  status cleanup_status NOT NULL,\n  execution_time_ms INTEGER,\n  created_at TIMESTAMP DEFAULT NOW() NOT NULL\n);\n\n-- Create index on created_at for efficient querying\nCREATE INDEX IF NOT EXISTS idx_cleanup_logs_created_at ON cleanup_logs(created_at DESC);\n\n-- Create index on triggered_by for user-specific queries\nCREATE INDEX IF NOT EXISTS idx_cleanup_logs_triggered_by ON cleanup_logs(triggered_by);\n\n-- Enable RLS\nALTER TABLE cleanup_logs ENABLE ROW LEVEL SECURITY;\n\n-- RLS Policy: Only admins can read cleanup logs\nDROP POLICY IF EXISTS \"Admin users can read all cleanup logs\" ON cleanup_logs;\nCREATE POLICY \"Admin users can read all cleanup logs\"\n  ON cleanup_logs\n  FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM users\n      WHERE users.id = auth.uid()\n      AND users.role = 'admin'\n    )\n  );\n\n-- RLS Policy: Only admins can insert cleanup logs\nDROP POLICY IF EXISTS \"Admin users can insert cleanup logs\" ON cleanup_logs;\nCREATE POLICY \"Admin users can insert cleanup logs\"\n  ON cleanup_logs\n  FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM users\n      WHERE users.id = auth.uid()\n      AND users.role = 'admin'\n    )\n  );\n\n-- Grant permissions\nGRANT SELECT, INSERT ON cleanup_logs TO authenticated;\nGRANT USAGE, SELECT ON SEQUENCE cleanup_logs_id_seq TO authenticated;",
  "returncode": 1,
  "logs": [
    "ERROR 1064 (42000) at line 2: You have an error in your SQL syntax; check the manual that corresponds to your TiDB version for the right syntax to use line 1 column 11 near \"BEGIN",
    "  CREATE TYPE cleanup_type AS ENUM ('age_based', 'storage_based', 'manual')\""
  ]
}